<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AutoCode Lifecycle Mockup — Bristlenose</title>
<style>
/* ================================================================
   AUTOCODE LIFECYCLE MOCKUP
   ================================================================
   End-to-end walkthrough of the Research Leader codebook experience:
   Step 1: Codebook tab with "Browse codebooks" button
   Step 2: Codebook picker modal
   Step 3: Preview page (within modal)
   Step 4: Codebook tab post-import with ✦ AutoCode button
   Step 5: AutoCode running (toast progress)
   Step 6: Report modal (triage table)
   Step 7: Proposed badges on quotes (pulsating)
   Step 8: Accept/Deny hover interaction
   Step 9: Settled state (confirmed tags)
   ================================================================ */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ── Design tokens ────────────────────────────────────────────── */

:root {
    --bn-font-body: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    --bn-font-mono: "SF Mono", "Fira Code", "Consolas", monospace;

    --bn-colour-bg: #ffffff;
    --bn-colour-text: #1a1a1a;
    --bn-colour-muted: #6b7280;
    --bn-colour-border: #e5e7eb;
    --bn-colour-accent: #2563eb;
    --bn-colour-quote-bg: #f9fafb;
    --bn-colour-badge-bg: #f3f4f6;
    --bn-colour-badge-text: #374151;
    --bn-colour-user-tag-bg: #f3f4f6;
    --bn-colour-icon-idle: #c9ccd1;
    --bn-colour-shadow: rgba(0, 0, 0, 0.1);
    --bn-colour-danger: #dc2626;
    --bn-colour-success: #16a34a;

    --bn-space-xs: 0.15rem;
    --bn-space-sm: 0.35rem;
    --bn-space-md: 0.75rem;
    --bn-space-lg: 1.5rem;
    --bn-space-xl: 2rem;

    --bn-radius-sm: 3px;
    --bn-radius-md: 6px;
    --bn-radius-lg: 8px;
    --bn-radius-pill: 999px;

    --bn-transition-fast: 0.15s ease;
    --bn-transition-normal: 0.2s ease;

    --bn-group-ux:    oklch(97% 0.015 250);
    --bn-group-emo:   oklch(97% 0.015 10);
    --bn-group-task:  oklch(97% 0.015 155);
    --bn-group-trust: oklch(97% 0.015 300);
    --bn-group-opp:   oklch(97% 0.015 75);
    --bn-group-none:  #f9fafb;

    --bn-ux-1-bg: oklch(94% 0.03 225);
    --bn-ux-2-bg: oklch(94% 0.03 237);
    --bn-ux-3-bg: oklch(94% 0.03 250);
    --bn-ux-4-bg: oklch(94% 0.03 263);
    --bn-ux-5-bg: oklch(94% 0.03 275);
    --bn-emo-1-bg: oklch(94% 0.03 340);
    --bn-emo-2-bg: oklch(94% 0.03 352);
    --bn-emo-3-bg: oklch(94% 0.03 4);
    --bn-emo-4-bg: oklch(94% 0.03 16);
    --bn-emo-5-bg: oklch(94% 0.03 28);
    --bn-emo-6-bg: oklch(94% 0.03 40);
    --bn-task-1-bg: oklch(94% 0.03 130);
    --bn-task-2-bg: oklch(94% 0.03 142);
    --bn-task-3-bg: oklch(94% 0.03 155);
    --bn-task-4-bg: oklch(94% 0.03 168);
    --bn-task-5-bg: oklch(94% 0.03 180);
    --bn-trust-1-bg: oklch(94% 0.03 275);
    --bn-trust-2-bg: oklch(94% 0.03 287);
    --bn-trust-3-bg: oklch(94% 0.03 300);
    --bn-trust-4-bg: oklch(94% 0.03 313);
    --bn-trust-5-bg: oklch(94% 0.03 325);
    --bn-opp-1-bg: oklch(94% 0.03 50);
    --bn-opp-2-bg: oklch(94% 0.03 62);
    --bn-opp-3-bg: oklch(94% 0.03 75);
    --bn-opp-4-bg: oklch(94% 0.03 88);
    --bn-opp-5-bg: oklch(94% 0.03 100);
    --bn-custom-bg: oklch(94% 0.005 260);

    --bn-bar-ux:    oklch(70% 0.08 250);
    --bn-bar-emo:   oklch(70% 0.08 10);
    --bn-bar-task:  oklch(70% 0.06 155);
    --bn-bar-trust: oklch(70% 0.07 300);
    --bn-bar-opp:   oklch(72% 0.07 75);
    --bn-bar-none:  #d1d5db;

    --bn-colour-hover: #e8f0fe;
    --bn-hover-bg: rgba(0,0,0,0.04);
    --bn-hover-bg-subtle: rgba(0,0,0,0.03);
    --bn-focus-ring: 0 0 0 2px rgba(37, 99, 235, 0.12);

    --bn-sentiment-frustration-bg: #fef2f2;
    --bn-sentiment-frustration: #b91c1c;
    --bn-sentiment-confusion-bg: #fff7ed;
    --bn-sentiment-confusion: #c2410c;
    --bn-sentiment-satisfaction-bg: #f0fdf4;
    --bn-sentiment-satisfaction: #15803d;
    --bn-sentiment-delight-bg: #eff6ff;
    --bn-sentiment-delight: #1d4ed8;
}

body {
    font-family: var(--bn-font-body);
    color: var(--bn-colour-text);
    background: #f5f5f5;
    line-height: 1.5;
    min-height: 100vh;
}

/* ── Fake Bristlenose chrome ─────────────────────────────────── */

.bn-chrome {
    max-width: 1200px;
    margin: 0 auto;
    background: var(--bn-colour-bg);
    min-height: 100vh;
    border-left: 1px solid var(--bn-colour-border);
    border-right: 1px solid var(--bn-colour-border);
}

/* Top bar */
.bn-topbar {
    display: flex;
    align-items: center;
    gap: var(--bn-space-md);
    padding: 0.6rem 1.5rem;
    border-bottom: 1px solid var(--bn-colour-border);
    background: var(--bn-colour-bg);
    position: sticky;
    top: 0;
    z-index: 30;
}
.bn-logo {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--bn-colour-text);
    letter-spacing: -0.02em;
}
.bn-logo-thin { font-weight: 400; }
.bn-project-name {
    font-size: 0.82rem;
    color: var(--bn-colour-muted);
    margin-left: auto;
}

/* Tab bar */
.bn-tabs {
    display: flex;
    border-bottom: 1px solid var(--bn-colour-border);
    padding: 0 1.5rem;
    background: var(--bn-colour-bg);
    position: sticky;
    top: 42px;
    z-index: 29;
}
.bn-tab {
    padding: 0.55rem 1rem;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--bn-colour-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: var(--bn-font-body);
    transition: color var(--bn-transition-fast), border-color var(--bn-transition-fast);
}
.bn-tab:hover { color: var(--bn-colour-text); }
.bn-tab.active {
    color: var(--bn-colour-accent);
    border-bottom-color: var(--bn-colour-accent);
}

/* Content area */
.bn-content {
    padding: 1.5rem;
    min-height: calc(100vh - 120px);
}

/* ── Step switcher (outside chrome) ──────────────────────────── */

.step-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1a1a1a;
    color: #9ca3af;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    font-family: var(--bn-font-mono);
    font-size: 0.7rem;
}
.step-nav button {
    background: #333;
    border: 1px solid #555;
    color: #e5e7eb;
    padding: 3px 10px;
    border-radius: var(--bn-radius-sm);
    cursor: pointer;
    font-family: var(--bn-font-mono);
    font-size: 0.7rem;
}
.step-nav button:hover { background: #444; }
.step-nav button:disabled { opacity: 0.3; cursor: default; }
.step-nav .step-label { color: #e5e7eb; flex: 1; }
.step-nav .step-counter { color: #60a5fa; margin-right: 8px; }

.step-panel { display: none; }
.step-panel.active { display: block; }

/* ── Theme toggle ────────────────────────────────────────────── */

.theme-toggle {
    position: fixed;
    top: 8px;
    right: 12px;
    padding: 3px 10px;
    border-radius: var(--bn-radius-pill);
    border: 1px solid var(--bn-colour-border);
    background: var(--bn-colour-bg);
    color: var(--bn-colour-muted);
    font-size: 0.65rem;
    cursor: pointer;
    font-family: var(--bn-font-body);
    z-index: 1000;
}

/* ── Button styles ────────────────────────────────────────────── */

.bn-btn {
    font-family: var(--bn-font-body);
    font-size: 0.82rem;
    font-weight: 500;
    padding: 0.45rem 1rem;
    border-radius: var(--bn-radius-sm);
    border: 1px solid var(--bn-colour-border);
    cursor: pointer;
    transition: background var(--bn-transition-fast), color var(--bn-transition-fast);
    display: inline-flex;
    align-items: center;
    gap: 0.3em;
}
.bn-btn-primary {
    background: var(--bn-colour-accent);
    color: #fff;
    border-color: var(--bn-colour-accent);
}
.bn-btn-primary:hover { filter: brightness(0.9); }
.bn-btn-ghost {
    background: none;
    border-color: transparent;
    color: var(--bn-colour-muted);
}
.bn-btn-ghost:hover { color: var(--bn-colour-text); background: var(--bn-hover-bg); }
.bn-btn-danger {
    background: none;
    border-color: transparent;
    color: var(--bn-colour-danger);
}
.bn-btn-success {
    background: var(--bn-colour-success);
    color: #fff;
    border-color: var(--bn-colour-success);
}

/* ── Badge styles ─────────────────────────────────────────────── */

.badge {
    display: inline-block;
    font-family: var(--bn-font-mono);
    font-size: 0.72rem;
    padding: var(--bn-space-xs) 0.45rem;
    border-radius: var(--bn-radius-sm);
    background: var(--bn-colour-badge-bg);
    color: var(--bn-colour-badge-text);
    white-space: nowrap;
}
.badge-lg {
    font-size: 0.82rem;
    padding: 0.2rem 0.5rem;
}

/* Framework prefix — uppercase at x-height of lowercase tag text */
.badge-framework-prefix {
    text-transform: uppercase;
    font-size: 0.65em;
    font-weight: 600;
    letter-spacing: 0.04em;
    margin-right: 0.3em;
    opacity: 0.8;
}

/* Sentiment badges */
.badge-frustration { background: var(--bn-sentiment-frustration-bg); color: var(--bn-sentiment-frustration); }
.badge-confusion { background: var(--bn-sentiment-confusion-bg); color: var(--bn-sentiment-confusion); }
.badge-satisfaction { background: var(--bn-sentiment-satisfaction-bg); color: var(--bn-sentiment-satisfaction); }
.badge-delight { background: var(--bn-sentiment-delight-bg); color: var(--bn-sentiment-delight); }

/* User tag badge */
.badge-user {
    color: var(--bn-colour-text);
    font-weight: 400;
}

/* Proposed badge — pulsating dashed border */
@keyframes bn-proposed-pulse {
    0%   { opacity: 0.50; }
    50%  { opacity: 0.78; }
    100% { opacity: 0.50; }
}

.badge-proposed {
    animation: bn-proposed-pulse 3s ease-in-out infinite;
    border: 1px dashed currentColor;
    cursor: pointer;
    position: relative;
}

/* Proposed badge hover — stop pulse, show actions */
.badge-proposed:hover {
    animation: none;
    opacity: 1 !important;
}

.badge-proposed-actions {
    display: none;
    gap: 0.3em;
    margin-left: 0.4em;
    align-items: center;
}
.badge-proposed:hover .badge-proposed-actions {
    display: inline-flex;
}

.badge-action-accept {
    color: var(--bn-colour-success);
    font-size: 0.7em;
    font-weight: 600;
    cursor: pointer;
    padding: 1px 3px;
    border-radius: 2px;
    transition: background var(--bn-transition-fast);
}
.badge-action-accept:hover { background: rgba(22, 163, 74, 0.1); }

.badge-action-deny {
    color: var(--bn-colour-danger);
    font-size: 0.7em;
    font-weight: 600;
    cursor: pointer;
    padding: 1px 3px;
    border-radius: 2px;
    transition: background var(--bn-transition-fast);
}
.badge-action-deny:hover { background: rgba(220, 38, 38, 0.1); }

/* Confirmed (settled) — same as user tag, solid */
.badge-confirmed {
    border: none;
    opacity: 1;
}

/* ── Blockquote (quote card) ──────────────────────────────────── */

blockquote {
    background: var(--bn-colour-quote-bg);
    border-left: 1px solid var(--bn-colour-border);
    margin: 0.8rem 0;
    padding: var(--bn-space-md) 1rem;
    border-radius: 0 var(--bn-radius-md) var(--bn-radius-md) 0;
    position: relative;
    padding-right: 4.5rem;
}

blockquote .quote-row {
    display: flex;
    gap: 0.5rem;
    align-items: baseline;
}
blockquote .timecode {
    color: var(--bn-colour-accent);
    font-family: var(--bn-font-mono);
    font-size: 0.8rem;
    flex-shrink: 0;
    text-decoration: none;
}
blockquote .quote-body { flex: 1; min-width: 0; }
blockquote .quote-text { font-size: 0.9rem; }
blockquote .speaker {
    color: var(--bn-colour-muted);
    font-size: 0.85rem;
}
blockquote .speaker-link {
    color: inherit;
    text-decoration: none;
}
blockquote .badges {
    display: flex;
    gap: var(--bn-space-sm);
    margin-top: 0.4rem;
    flex-wrap: wrap;
    opacity: 0.9;
    transition: opacity var(--bn-transition-fast);
    align-items: center;
}
blockquote:hover .badges { opacity: 1; }

/* Quote actions (hide/edit/star) */
.quote-actions {
    position: absolute;
    top: var(--bn-space-md);
    right: var(--bn-space-md);
    display: flex;
    gap: 0.3rem;
    opacity: 0;
    transition: opacity var(--bn-transition-fast);
}
blockquote:hover .quote-actions { opacity: 1; }
.quote-action-btn {
    background: none;
    border: none;
    color: var(--bn-colour-icon-idle);
    cursor: pointer;
    font-size: 0.85rem;
    padding: 2px;
    transition: color var(--bn-transition-fast);
}
.quote-action-btn:hover { color: var(--bn-colour-text); }

/* ── Codebook panel ───────────────────────────────────────────── */

.codebook-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--bn-space-sm);
}
.codebook-title { font-size: 1.15rem; font-weight: 600; }
.codebook-description {
    font-size: 0.82rem;
    color: var(--bn-colour-muted);
    margin-bottom: var(--bn-space-lg);
}

.codebook-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: var(--bn-space-lg);
    align-items: start;
}

.codebook-group {
    border-radius: var(--bn-radius-lg);
    padding: 12px;
    min-height: 80px;
    position: relative;
    border: 1px solid transparent;
}

.group-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 6px;
    gap: 4px;
}
.group-title-area { flex: 1; min-width: 0; }
.group-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--bn-colour-text);
    line-height: 1.3;
}
.group-subtitle {
    font-size: 0.78rem;
    color: var(--bn-colour-muted);
    margin-top: 1px;
    line-height: 1.4;
}
.group-subtitle.placeholder {
    font-style: italic;
    opacity: 0.45;
}
.group-close {
    background: none;
    border: none;
    font-size: 1rem;
    line-height: 1;
    color: var(--bn-colour-muted);
    cursor: pointer;
    padding: 0.15rem 0.3rem;
    border-radius: var(--bn-radius-sm);
    opacity: 0;
    transition: opacity var(--bn-transition-fast);
    flex-shrink: 0;
}
.codebook-group:hover .group-close { opacity: 0.5; }
.group-close:hover { opacity: 1 !important; color: var(--bn-colour-text); }

.tag-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.tag-row {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 6px;
    padding: 3px 4px;
    border-radius: var(--bn-radius-sm);
}
.tag-row:hover { background: var(--bn-hover-bg-subtle); }
.tag-name-area {
    display: flex;
    align-items: center;
    min-width: 0;
}
.tag-bar-area {
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 50px;
    justify-content: flex-end;
}
.tag-micro-bar {
    height: 0.6rem;
    border-radius: 0 var(--bn-radius-sm) var(--bn-radius-sm) 0;
    min-width: 2px;
}
.tag-count {
    font-size: 0.75rem;
    color: var(--bn-colour-muted);
    min-width: 16px;
    text-align: right;
    font-variant-numeric: tabular-nums;
}

.group-total-row {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 6px;
    padding: 0 4px 4px;
}
.group-total-label {
    font-size: 0.7rem;
    color: var(--bn-colour-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
}
.group-total-count {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--bn-colour-muted);
    font-variant-numeric: tabular-nums;
    min-width: 16px;
    text-align: right;
}

.new-group-placeholder {
    border: 1px dashed var(--bn-colour-border);
    border-radius: var(--bn-radius-lg);
    padding: var(--bn-space-lg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 120px;
    gap: var(--bn-space-sm);
    cursor: pointer;
    transition: border-color var(--bn-transition-fast), background var(--bn-transition-fast);
}
.new-group-placeholder:hover {
    border-color: var(--bn-colour-muted);
    background: var(--bn-hover-bg-subtle);
}
.new-group-placeholder .new-icon { font-size: 1.2rem; color: var(--bn-colour-muted); }
.new-group-placeholder .new-label { font-size: 0.82rem; color: var(--bn-colour-muted); }

/* Framework separator */
.framework-separator {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    gap: var(--bn-space-md);
    margin: var(--bn-space-sm) 0;
}
.framework-separator-line {
    flex: 1;
    height: 1px;
    background: var(--bn-colour-border);
}
.framework-separator-label {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--bn-colour-text);
    white-space: nowrap;
}
.framework-separator-actions {
    display: flex;
    align-items: center;
    gap: var(--bn-space-sm);
    flex-shrink: 0;
}

/* AutoCode button in separator — .bn-btn-primary style */
.autocode-btn {
    font-family: var(--bn-font-body);
    font-size: 0.78rem;
    font-weight: 500;
    padding: 0.3rem 0.7rem;
    border-radius: var(--bn-radius-sm);
    border: 1px solid var(--bn-colour-accent);
    background: var(--bn-colour-accent);
    color: #fff;
    cursor: pointer;
    transition: opacity var(--bn-transition-fast);
    display: inline-flex;
    align-items: center;
    gap: 0.3em;
    white-space: nowrap;
}
.autocode-btn:hover {
    opacity: 0.85;
}
.autocode-btn .sparkle { font-size: 0.85em; }

/* Proposed count badge */
.proposed-count {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--bn-colour-accent);
    background: rgba(37, 99, 235, 0.08);
    padding: 0.15rem 0.5rem;
    border-radius: var(--bn-radius-pill);
    white-space: nowrap;
}

/* ── Modal / overlay ──────────────────────────────────────────── */

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.modal {
    background: var(--bn-colour-bg);
    border-radius: var(--bn-radius-lg);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.modal-lg { max-width: 56rem; }
.modal-xl { max-width: 56rem; }

.modal-header {
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid var(--bn-colour-border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0;
}
.modal-title { font-size: 1.1rem; font-weight: 600; }
.modal-subtitle { font-size: 0.82rem; color: var(--bn-colour-muted); margin-top: 0.2rem; }
.modal-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: var(--bn-colour-muted);
    cursor: pointer;
    padding: 0.2rem;
    line-height: 1;
}
.modal-close:hover { color: var(--bn-colour-text); }

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--bn-colour-border);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    flex-shrink: 0;
}

/* ── Picker styles (inside modal) ─────────────────────────────── */

.picker-section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin: var(--bn-space-xl) 0 var(--bn-space-md);
}
.picker-section-header:first-child { margin-top: 0; }
.picker-section-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--bn-colour-muted);
    font-weight: 600;
}

.picker-row {
    display: flex;
    gap: var(--bn-space-lg);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-bottom: var(--bn-space-sm);
}
.picker-row::-webkit-scrollbar { height: 6px; }
.picker-row::-webkit-scrollbar-thumb { background: var(--bn-colour-border); border-radius: 3px; }

.picker-card {
    background: var(--bn-colour-bg);
    border: 1px solid var(--bn-colour-border);
    border-radius: var(--bn-radius-lg);
    padding: var(--bn-space-lg);
    cursor: pointer;
    transition: border-color var(--bn-transition-fast), background-color var(--bn-transition-fast);
    width: 260px;
    min-width: 260px;
    flex-shrink: 0;
    scroll-snap-align: start;
}
.picker-card:hover { border-color: var(--bn-colour-accent); background-color: var(--bn-colour-hover); }
/* .picker-card.featured — removed, no special border */
.picker-card.disabled { opacity: 0.45; cursor: default; pointer-events: none; }
.picker-card.imported {
    border-color: var(--bn-colour-success);
    position: relative;
}
.picker-card.imported::after {
    content: "Imported";
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--bn-colour-success);
    background: rgba(22, 163, 74, 0.08);
    padding: 2px 6px;
    border-radius: var(--bn-radius-sm);
}

.picker-card-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.15rem; }
.picker-card-author { font-size: 0.82rem; color: var(--bn-colour-muted); margin-bottom: 0.5rem; }
.picker-card-desc { font-size: 0.82rem; color: var(--bn-colour-muted); line-height: 1.5; }
.picker-card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: var(--bn-space-md); }
.picker-card-coming { font-size: 0.72rem; color: var(--bn-colour-muted); font-style: italic; margin-top: 4px; }
.picker-card-create {
    border: 1px dashed var(--bn-colour-border);
    background: transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 140px;
    gap: var(--bn-space-sm);
}
.picker-card-create:hover { border-color: var(--bn-colour-muted); background: var(--bn-hover-bg-subtle); }
.picker-card-create .new-icon { font-size: 1.2rem; color: var(--bn-colour-muted); }
.picker-card-create .new-label { font-size: 0.82rem; color: var(--bn-colour-muted); }

/* ── Preview (inside modal) ───────────────────────────────────── */

.preview-back {
    font-size: 0.82rem;
    color: var(--bn-colour-muted);
    cursor: pointer;
    background: none;
    border: none;
    font-family: var(--bn-font-body);
    margin-bottom: var(--bn-space-lg);
    padding: 0;
}
.preview-back:hover { color: var(--bn-colour-accent); }

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--bn-space-xl);
    margin-bottom: var(--bn-space-lg);
    padding-bottom: var(--bn-space-md);
    border-bottom: 1px solid var(--bn-colour-border);
}
.preview-header-left { flex: 1; min-width: 0; }
.preview-header-right { flex-shrink: 0; text-align: right; }
.preview-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 0.15rem; }
.preview-subtitle { font-size: 0.88rem; color: var(--bn-colour-muted); }
.preview-cta-help { font-size: 0.72rem; color: var(--bn-colour-muted); margin-top: 0.3rem; }

.preview-body {
    display: flex;
    gap: var(--bn-space-xl);
    align-items: flex-start;
}
.preview-body-main { flex: 1; min-width: 0; }
.preview-body-sidebar { width: 260px; flex-shrink: 0; }

.preview-desc {
    font-size: 0.9rem;
    color: var(--bn-colour-muted);
    line-height: 1.6;
    margin-bottom: var(--bn-space-lg);
}

.preview-section-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--bn-colour-muted);
    font-weight: 600;
    margin-bottom: var(--bn-space-md);
}

.preview-groups {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--bn-space-lg);
    align-items: start;
}

.preview-author {
    background: var(--bn-colour-quote-bg);
    border-radius: var(--bn-radius-lg);
    padding: var(--bn-space-lg);
}
.preview-author-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
.preview-author-bio { font-size: 0.75rem; color: var(--bn-colour-muted); margin-bottom: var(--bn-space-md); line-height: 1.5; }
.preview-author-links { display: flex; flex-wrap: wrap; gap: var(--bn-space-lg); font-size: 0.78rem; }
.preview-author-links a { color: var(--bn-colour-accent); text-decoration: none; }
.preview-author-links a:hover { text-decoration: underline; }

/* ── AutoCode toast ───────────────────────────────────────────── */

.autocode-toast {
    position: fixed;
    bottom: 48px;
    right: 24px;
    background: var(--bn-colour-text);
    color: var(--bn-colour-bg);
    padding: 0.6rem 1rem;
    border-radius: var(--bn-radius-lg);
    font-size: 0.82rem;
    z-index: 200;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    font-family: var(--bn-font-body);
}
.toast-spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.2);
    border-top-color: #60a5fa;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.toast-check { color: var(--bn-colour-success); font-weight: 700; }
.toast-link {
    color: #60a5fa;
    text-decoration: none;
    font-weight: 500;
    margin-left: 0.3rem;
    cursor: pointer;
}
.toast-link:hover { text-decoration: underline; }
.toast-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.4);
    cursor: pointer;
    font-size: 0.9rem;
    padding: 0 0.2rem;
    margin-left: 0.3rem;
}
.toast-close:hover { color: rgba(255,255,255,0.8); }

/* ── Report modal ─────────────────────────────────────────────── */

.report-table {
    width: 100%;
    border-collapse: collapse;
}
.report-session-header {
    font-size: 0.88rem;
    color: var(--bn-colour-muted);
    padding: 0.8rem 0 0.4rem;
    font-weight: 600;
    border-bottom: none;
}
.report-row {
    border-bottom: 1px solid var(--bn-colour-border);
    transition: background var(--bn-transition-fast), opacity var(--bn-transition-fast), max-height 0.2s ease;
}
.report-row:hover { background: var(--bn-hover-bg-subtle); }
.report-row td {
    padding: 0.5rem 0.5rem;
    vertical-align: baseline;
    font-size: 0.85rem;
}
.report-row td:first-child { padding-left: 0; }
.report-timecode {
    font-family: var(--bn-font-mono);
    font-size: 0.78rem;
    white-space: nowrap;
    width: 60px;
}
.report-timecode a {
    color: var(--bn-colour-accent);
    text-decoration: none;
}
.report-timecode a:hover {
    text-decoration: underline;
}
.report-quote {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 350px;
    color: var(--bn-colour-text);
    cursor: help;
}
.report-speaker {
    white-space: nowrap;
    color: var(--bn-colour-muted);
    font-size: 0.78rem;
    width: 60px;
}
.report-tag { width: auto; }
.report-deny { width: 32px; text-align: center; }
.report-deny-btn {
    background: none;
    border: none;
    color: var(--bn-colour-muted);
    cursor: pointer;
    font-size: 0.9rem;
    padding: 2px 4px;
    border-radius: var(--bn-radius-sm);
    transition: color var(--bn-transition-fast), background var(--bn-transition-fast);
}
.report-deny-btn:hover {
    color: var(--bn-colour-danger);
    background: rgba(220, 38, 38, 0.06);
}

/* Report row removal animation */
.report-row.removing {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    border: none;
}
.report-row.removing td { padding-top: 0; padding-bottom: 0; }

/* Rationale tooltip */
.has-tooltip {
    position: relative;
}
.has-tooltip .tooltip {
    display: none;
    position: absolute;
    bottom: calc(100% + 4px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--bn-colour-text);
    color: var(--bn-colour-bg);
    font-size: 0.72rem;
    padding: 0.4rem 0.6rem;
    border-radius: var(--bn-radius-sm);
    white-space: normal;
    width: max-content;
    max-width: 280px;
    z-index: 300;
    line-height: 1.4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-family: var(--bn-font-body);
}
.has-tooltip:hover .tooltip { display: block; }

/* ── Section heading ──────────────────────────────────────────── */

.section-heading {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 1.5rem 0 0.5rem;
    padding-bottom: 0.3rem;
    border-bottom: 1px solid var(--bn-colour-border);
}

/* ── Step annotation ──────────────────────────────────────────── */

.step-annotation {
    background: rgba(37, 99, 235, 0.04);
    border: 1px solid rgba(37, 99, 235, 0.15);
    border-radius: var(--bn-radius-md);
    padding: 0.6rem 1rem;
    margin-bottom: 1rem;
    font-size: 0.82rem;
    color: var(--bn-colour-muted);
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}
.step-annotation strong { color: var(--bn-colour-accent); font-weight: 600; }
.step-number {
    background: var(--bn-colour-accent);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    width: 1.3rem;
    height: 1.3rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
}

/* ── Dark mode ────────────────────────────────────────────────── */

[data-theme="dark"] {
    --bn-colour-bg: #111111;
    --bn-colour-text: #e5e7eb;
    --bn-colour-muted: #9ca3af;
    --bn-colour-border: #2d2d2d;
    --bn-colour-accent: #60a5fa;
    --bn-colour-quote-bg: #1a1a1a;
    --bn-colour-badge-bg: #252525;
    --bn-colour-badge-text: #d1d5db;
    --bn-colour-user-tag-bg: #252525;
    --bn-colour-icon-idle: #595959;
    --bn-colour-shadow: rgba(0, 0, 0, 0.3);
    --bn-colour-danger: #f87171;
    --bn-colour-success: #4ade80;

    --bn-group-ux:    oklch(22% 0.025 250);
    --bn-group-emo:   oklch(22% 0.025 10);
    --bn-group-task:  oklch(22% 0.020 155);
    --bn-group-trust: oklch(22% 0.025 300);
    --bn-group-opp:   oklch(22% 0.022 75);
    --bn-group-none:  #1e1e1e;

    --bn-ux-1-bg: oklch(50% 0.12 225);
    --bn-ux-2-bg: oklch(48% 0.11 237);
    --bn-ux-3-bg: oklch(53% 0.12 250);
    --bn-ux-4-bg: oklch(55% 0.10 263);
    --bn-ux-5-bg: oklch(49% 0.11 275);
    --bn-emo-1-bg: oklch(50% 0.12 340);
    --bn-emo-2-bg: oklch(48% 0.11 352);
    --bn-emo-3-bg: oklch(53% 0.10 4);
    --bn-emo-4-bg: oklch(49% 0.12 16);
    --bn-emo-5-bg: oklch(55% 0.10 28);
    --bn-emo-6-bg: oklch(51% 0.11 40);
    --bn-task-1-bg: oklch(50% 0.10 130);
    --bn-task-2-bg: oklch(48% 0.09 142);
    --bn-task-3-bg: oklch(53% 0.09 155);
    --bn-task-4-bg: oklch(49% 0.10 168);
    --bn-task-5-bg: oklch(51% 0.09 180);
    --bn-trust-1-bg: oklch(50% 0.11 275);
    --bn-trust-2-bg: oklch(48% 0.10 287);
    --bn-trust-3-bg: oklch(53% 0.10 300);
    --bn-trust-4-bg: oklch(49% 0.11 313);
    --bn-trust-5-bg: oklch(51% 0.10 325);
    --bn-opp-1-bg: oklch(52% 0.11 50);
    --bn-opp-2-bg: oklch(50% 0.10 62);
    --bn-opp-3-bg: oklch(54% 0.12 75);
    --bn-opp-4-bg: oklch(48% 0.10 88);
    --bn-opp-5-bg: oklch(51% 0.11 100);
    --bn-custom-bg: oklch(52% 0.02 260);

    --bn-bar-ux:    oklch(55% 0.08 250);
    --bn-bar-emo:   oklch(55% 0.08 10);
    --bn-bar-task:  oklch(55% 0.06 155);
    --bn-bar-trust: oklch(55% 0.07 300);
    --bn-bar-opp:   oklch(57% 0.07 75);
    --bn-bar-none:  #4b5563;

    --bn-colour-hover: #1e293b;
    --bn-hover-bg: rgba(255,255,255,0.06);
    --bn-hover-bg-subtle: rgba(255,255,255,0.04);

    --bn-sentiment-frustration-bg: rgba(185, 28, 28, 0.15);
    --bn-sentiment-confusion-bg: rgba(194, 65, 12, 0.15);
    --bn-sentiment-satisfaction-bg: rgba(21, 128, 61, 0.15);
    --bn-sentiment-delight-bg: rgba(29, 78, 216, 0.15);
}

[data-theme="dark"] .badge {
    color: #ffffff;
    font-weight: 500;
}
[data-theme="dark"] .bn-chrome { background: var(--bn-colour-bg); }
[data-theme="dark"] body { background: #0a0a0a; }
[data-theme="dark"] .autocode-toast { background: #e5e7eb; color: #111; }
[data-theme="dark"] .autocode-toast .toast-link { color: #2563eb; }
[data-theme="dark"] .autocode-toast .toast-close { color: rgba(0,0,0,0.3); }
[data-theme="dark"] .autocode-toast .toast-close:hover { color: rgba(0,0,0,0.7); }
[data-theme="dark"] .autocode-toast .toast-spinner { border-color: rgba(0,0,0,0.15); border-top-color: #2563eb; }
</style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()">Toggle dark mode</button>

<div class="bn-chrome">
    <!-- Top bar -->
    <div class="bn-topbar">
        <div class="bn-logo">bristle<span class="bn-logo-thin">nose</span></div>
        <span class="bn-project-name">Project Ikea \u2014 Fishkeeping study</span>
    </div>

    <!-- Tab bar -->
    <div class="bn-tabs">
        <button class="bn-tab" data-tab="report">Report</button>
        <button class="bn-tab" data-tab="sessions">Sessions</button>
        <button class="bn-tab" data-tab="dashboard">Dashboard</button>
        <button class="bn-tab active" data-tab="codebook">Codebook</button>
        <button class="bn-tab" data-tab="analysis">Analysis</button>
    </div>

    <div class="bn-content" id="main-content"></div>
</div>

<!-- Step navigation bar -->
<div class="step-nav">
    <button id="step-prev" onclick="changeStep(-1)">\u2190 Prev</button>
    <span class="step-counter" id="step-counter">1 / 9</span>
    <span class="step-label" id="step-label">Codebook tab \u2014 before import</span>
    <button id="step-next" onclick="changeStep(1)">Next \u2192</button>
</div>

<script>
// ================================================================
//  HELPERS
// ================================================================

var CS = {
    ux:    { slots: 5, bgVar: '--bn-ux-',    groupBg: '--bn-group-ux',    barVar: '--bn-bar-ux' },
    emo:   { slots: 6, bgVar: '--bn-emo-',   groupBg: '--bn-group-emo',   barVar: '--bn-bar-emo' },
    task:  { slots: 5, bgVar: '--bn-task-',  groupBg: '--bn-group-task',  barVar: '--bn-bar-task' },
    trust: { slots: 5, bgVar: '--bn-trust-', groupBg: '--bn-group-trust', barVar: '--bn-bar-trust' },
    opp:   { slots: 5, bgVar: '--bn-opp-',   groupBg: '--bn-group-opp',   barVar: '--bn-bar-opp' }
};
function tagBg(cs, i) {
    if (!cs) return 'var(--bn-custom-bg)';
    var s = CS[cs]; if (!s) return 'var(--bn-custom-bg)';
    return 'var(' + s.bgVar + ((i % s.slots) + 1) + '-bg)';
}
function barCol(cs) {
    if (!cs) return 'var(--bn-bar-none)';
    var s = CS[cs]; return s ? 'var(' + s.barVar + ')' : 'var(--bn-bar-none)';
}
function groupBg(cs) {
    if (!cs) return 'var(--bn-group-none)';
    var s = CS[cs]; return s ? 'var(' + s.groupBg + ')' : 'var(--bn-group-none)';
}
function E(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function badge(text, cs, idx, extra) {
    extra = extra || '';
    return '<span class="badge ' + extra + '" style="background:' + tagBg(cs, idx) + '">' + E(text) + '</span>';
}
function badgeLg(text, cs, idx) {
    return '<span class="badge badge-lg" style="background:' + tagBg(cs, idx) + '">' + E(text) + '</span>';
}
function badgeProposed(text, cs, idx, rationale) {
    return '<span class="badge badge-proposed has-tooltip" style="background:' + tagBg(cs, idx) + '; border-color:' + barCol(cs) + '">' +
        E(text) +
        '<span class="badge-proposed-actions">' +
            '<span class="badge-action-accept" title="Accept">\u2713</span>' +
            '<span class="badge-action-deny" title="Deny">\u2717</span>' +
        '</span>' +
        '<span class="tooltip">' + E(rationale) + '</span>' +
    '</span>';
}
function badgeConfirmed(text, cs, idx) {
    return '<span class="badge badge-confirmed badge-user" style="background:' + tagBg(cs, idx) + '">' + E(text) + '</span>';
}

// ================================================================
//  DATA
// ================================================================

var researcherGroups = [
    { name: 'Uncategorised', subtitle: 'New tags appear here until assigned to a group',
      colourSet: null, isDefault: true, closable: false, tags: [
        { name: 'interesting', count: 14 }, { name: 'follow-up', count: 9 },
        { name: 'compare with v1', count: 3 }, { name: 'revisit', count: 2 }
    ]},
    { name: 'Friction', subtitle: 'Pain points and blockers',
      colourSet: 'emo', closable: true, tags: [
        { name: 'confusion', count: 18 }, { name: 'dead end', count: 12 },
        { name: 'error recovery', count: 9 }, { name: 'cognitive load', count: 7 },
        { name: 'workaround', count: 5 }
    ]},
    { name: 'Navigation', subtitle: 'Wayfinding and information architecture',
      colourSet: 'ux', closable: true, tags: [
        { name: 'lost', count: 11 }, { name: 'breadcrumbs', count: 8 },
        { name: 'search failure', count: 6 }, { name: 'deep linking', count: 4 }
    ]},
    { name: 'Trust signals', subtitle: '',
      colourSet: 'trust', closable: true, tags: [
        { name: 'credibility concern', count: 15 }, { name: 'social proof', count: 10 },
        { name: 'privacy worry', count: 7 }, { name: 'data ownership', count: 4 }
    ]},
    { name: 'Opportunities', subtitle: 'Feature requests and unmet needs',
      colourSet: 'opp', closable: true, tags: [
        { name: 'feature request', count: 21 }, { name: 'unmet need', count: 13 },
        { name: 'competitor mention', count: 8 }, { name: 'willingness to pay', count: 5 }
    ]}
];

var garrettGroups = [
    { name: 'Strategy', subtitle: 'Is the product solving the right problem for the right users?',
      colourSet: 'ux', closable: false, tags: [
        { name: 'user need', count: 0 }, { name: 'business objective', count: 0 },
        { name: 'success metric', count: 0 }, { name: 'value proposition', count: 0 }
    ]},
    { name: 'Scope', subtitle: 'What features and content are included or excluded?',
      colourSet: 'emo', closable: false, tags: [
        { name: 'feature gap', count: 0 }, { name: 'content requirement', count: 0 },
        { name: 'priority', count: 0 }, { name: 'scope creep', count: 0 }
    ]},
    { name: 'Structure', subtitle: 'How is information organised conceptually?',
      colourSet: 'task', closable: false, tags: [
        { name: 'information architecture', count: 0 }, { name: 'interaction design', count: 0 },
        { name: 'navigation pattern', count: 0 }, { name: 'task flow', count: 0 }
    ]},
    { name: 'Skeleton', subtitle: 'How are interface elements arranged?',
      colourSet: 'trust', closable: false, tags: [
        { name: 'interface layout', count: 0 }, { name: 'wireframe issue', count: 0 },
        { name: 'convention', count: 0 }, { name: 'component placement', count: 0 }
    ]},
    { name: 'Surface', subtitle: 'What is the visual treatment?',
      colourSet: 'opp', closable: false, tags: [
        { name: 'visual design', count: 0 }, { name: 'sensory experience', count: 0 },
        { name: 'brand alignment', count: 0 }, { name: 'aesthetic reaction', count: 0 }
    ]}
];

// Post-AutoCode counts
var garrettGroupsWithCounts = JSON.parse(JSON.stringify(garrettGroups));
garrettGroupsWithCounts[0].tags[0].count = 4;  // user need
garrettGroupsWithCounts[1].tags[0].count = 7;  // feature gap
garrettGroupsWithCounts[1].tags[1].count = 3;  // content requirement
garrettGroupsWithCounts[2].tags[0].count = 5;  // information architecture
garrettGroupsWithCounts[2].tags[2].count = 3;  // navigation pattern
garrettGroupsWithCounts[3].tags[0].count = 2;  // interface layout
garrettGroupsWithCounts[3].tags[3].count = 4;  // component placement
garrettGroupsWithCounts[4].tags[0].count = 3;  // visual design
garrettGroupsWithCounts[4].tags[3].count = 2;  // aesthetic reaction

var reportRows = [
    { tc: '0:02:14', quote: '\u201cI would have expected angelfish to be listed under tropical freshwater, not just in a generic \u2018fish\u2019 category...\u201d',
      speakerCode: 'p1', tag: 'information architecture', group: 'Structure', cs: 'task', idx: 0,
      rationale: 'Participant expected species categorised by habitat type \u2014 information architecture gap in taxonomy, not navigation placement' },
    { tc: '0:03:41', quote: '\u201cThey don\u2019t have any water parameters listed for any of the fish \u2014 temperature, pH, hardness, nothing.\u201d',
      speakerCode: 'p1', tag: 'content requirement', group: 'Scope', cs: 'emo', idx: 1,
      rationale: 'Absent water chemistry data is a content gap \u2014 the information doesn\u2019t exist, not misplaced' },
    { tc: '0:05:08', quote: '\u201cThe photos look really professional, actually. Better than most fish shops I\u2019ve seen online.\u201d',
      speakerCode: 'p1', tag: 'visual design', group: 'Surface', cs: 'opp', idx: 0,
      rationale: 'Participant comments on photography quality \u2014 aesthetic appreciation of visual treatment, not trust signal' },
    { tc: '0:07:22', quote: '\u201cI can\u2019t find where to filter by tank size \u2014 I\u2019d expect that on the left sidebar somewhere.\u201d',
      speakerCode: 'p1', tag: 'component placement', group: 'Skeleton', cs: 'trust', idx: 3,
      rationale: 'Missing filter in expected sidebar location \u2014 layout/placement issue, not information architecture' },
    { tc: '0:09:15', quote: '\u201cI\u2019m not sure this shop is really aimed at serious fishkeepers \u2014 it feels more like a beginner\u2019s place.\u201d',
      speakerCode: 'p1', tag: 'user need', group: 'Strategy', cs: 'ux', idx: 0,
      rationale: 'Questions whether the product targets their segment \u2014 strategic mismatch, not a feature gap' },
    { tc: '0:12:05', quote: '\u201cI\u2019ve tried dedicated climbing gear shops but none of them let you search by crag or route grade.\u201d',
      speakerCode: 'p3', tag: 'feature gap', group: 'Scope', cs: 'emo', idx: 0,
      rationale: 'Missing search/filter capability \u2014 functional gap in product scope' },
    { tc: '0:14:32', quote: '\u201cThe way they\u2019ve grouped shoes and harnesses together doesn\u2019t make sense \u2014 those are completely different purchase decisions.\u201d',
      speakerCode: 'p3', tag: 'information architecture', group: 'Structure', cs: 'task', idx: 0,
      rationale: 'Conceptual category grouping mismatch \u2014 architecture of categories, not visual layout' },
    { tc: '0:16:48', quote: '\u201cI like that the route descriptions include photos from actual climbers, not just stock images.\u201d',
      speakerCode: 'p3', tag: 'aesthetic reaction', group: 'Surface', cs: 'opp', idx: 3,
      rationale: 'Positive response to authentic imagery \u2014 sensory/emotional reaction to visual content' }
];

var pickerCards = [
    { id: 'default', title: 'Bristlenose UXR Codebook', author: '',
      desc: 'Domain-agnostic codebook for any user research study.',
      sampleTags: [
        { name: 'behavioural pattern', set: 'ux', idx: 0 }, { name: 'pain point', set: 'emo', idx: 0 },
        { name: 'unmet need', set: 'emo', idx: 1 }, { name: 'mental model', set: 'task', idx: 0 }
      ], enabled: true, featured: false, imported: false },
    { id: 'garrett', title: 'The Elements of User Experience', author: 'Jesse James Garrett',
      desc: 'Five mutually exclusive planes from abstract strategy to concrete surface design.',
      sampleTags: [
        { name: 'strategy', set: 'ux', idx: 0 }, { name: 'scope', set: 'emo', idx: 0 },
        { name: 'structure', set: 'task', idx: 0 }, { name: 'skeleton', set: 'trust', idx: 0 },
        { name: 'surface', set: 'opp', idx: 0 }
      ], enabled: true, featured: false, imported: false },
    { id: 'norman', title: 'The Design of Everyday Things', author: 'Don Norman',
      desc: 'Seven fundamental design principles for diagnosing interaction.',
      sampleTags: [
        { name: 'discoverability', set: 'ux', idx: 0 }, { name: 'feedback', set: 'emo', idx: 0 },
        { name: 'conceptual model', set: 'task', idx: 0 }, { name: 'signifier', set: 'trust', idx: 0 }
      ], enabled: false, featured: false, imported: false },
    { id: 'morville', title: 'The User Experience Honeycomb', author: 'Peter Morville',
      desc: 'Seven facets of UX quality: useful, usable, desirable, findable, accessible, credible, valuable.',
      sampleTags: [
        { name: 'useful', set: 'ux', idx: 0 }, { name: 'credible', set: 'trust', idx: 0 },
        { name: 'findable', set: 'task', idx: 0 }, { name: 'desirable', set: 'emo', idx: 0 }
      ], enabled: false, featured: false, imported: false }
];

// ================================================================
//  RENDERERS
// ================================================================

function renderGroup(group, mc, maxBarW) {
    var h = '<div class="codebook-group" style="background:' + groupBg(group.colourSet) + '">';
    h += '<div class="group-header"><div class="group-title-area">';
    h += '<div class="group-title">' + E(group.name) + '</div>';
    if (group.subtitle) h += '<div class="group-subtitle">' + E(group.subtitle) + '</div>';
    else if (!group.isDefault && group.closable) h += '<div class="group-subtitle placeholder">Add subtitle\u2026</div>';
    h += '</div>';
    if (group.closable) h += '<button class="group-close" title="Delete group">&times;</button>';
    h += '</div>';
    h += '<div class="tag-list">';
    var total = group.tags.reduce(function(s, t) { return s + t.count; }, 0);
    if (total > 0) {
        h += '<div class="group-total-row"><span class="group-total-label">' + group.tags.length + ' tags</span>';
        h += '<span class="group-total-count">' + total + '</span></div>';
    }
    group.tags.forEach(function(tag, idx) {
        h += '<div class="tag-row"><div class="tag-name-area">';
        h += badgeLg(tag.name, group.colourSet, idx);
        h += '</div><div class="tag-bar-area">';
        if (tag.count > 0) {
            var barW = Math.max(2, Math.round((tag.count / mc) * maxBarW));
            h += '<div class="tag-micro-bar" style="width:' + barW + 'px; background:' + barCol(group.colourSet) + '"></div>';
        }
        h += '<span class="tag-count">' + tag.count + '</span>';
        h += '</div></div>';
    });
    h += '</div></div>';
    return h;
}

function renderCodebookGrid(groups, fwGroups, fwLabel, showAutoCode, autoCodeState, proposedCount) {
    var all = groups.concat(fwGroups);
    var mc = 1;
    all.forEach(function(g) { g.tags.forEach(function(t) { if (t.count > mc) mc = t.count; }); });
    var bw = 48;

    var h = '<div class="codebook-header">';
    h += '<div><div class="codebook-title">Project Ikea codebook</div>';
    h += '<p class="codebook-description">Drag tags between groups to reorganise. Click a tag or title to rename it.</p></div>';
    h += '<button class="bn-btn bn-btn-primary" onclick="openPickerModal()" style="flex-shrink:0">\uD83D\uDCDA Browse codebooks</button>';
    h += '</div>';

    h += '<div class="codebook-grid">';
    groups.forEach(function(g) { h += renderGroup(g, mc, bw); });
    h += '<div class="new-group-placeholder"><span class="new-icon">+</span><span class="new-label">New group</span></div>';

    if (fwLabel) {
        h += '<div class="framework-separator">';
        h += '<div class="framework-separator-line"></div>';
        h += '<div class="framework-separator-label">' + E(fwLabel) + '</div>';
        h += '<div class="framework-separator-line"></div>';
        if (showAutoCode) {
            h += '<div class="framework-separator-actions">';
            if (proposedCount > 0) {
                h += '<span class="proposed-count">' + proposedCount + ' proposed</span>';
            }
            if (autoCodeState === 'ready') {
                h += '<button class="autocode-btn" onclick="changeStep(1)"><span class="sparkle">\u2726</span> AutoCode quotes</button>';
            } else if (autoCodeState === 'done') {
                h += '<button class="autocode-btn" style="opacity:0.5; pointer-events:none"><span class="sparkle">\u2726</span> AutoCode quotes</button>';
            }
            h += '</div>';
        }
        h += '</div>';
        fwGroups.forEach(function(g) { h += renderGroup(g, mc, bw); });
    }

    h += '</div>';
    return h;
}

function renderQuotes(proposed, settled) {
    var h = '<h2 class="section-heading">Navigation &amp; wayfinding</h2>';

    // Quote 1 — with proposed tag
    h += '<blockquote>';
    h += '<div class="quote-row"><a class="timecode">0:02:14</a><div class="quote-body">';
    h += '<span class="quote-text">\u201cI would have expected angelfish to be listed under tropical freshwater, not just in a generic \u2018fish\u2019 category...\u201d</span>';
    h += '&nbsp;<span class="speaker">\u2014&nbsp;<a class="speaker-link">[p1] Yuki Tanaka</a></span>';
    h += '<div class="badges">';
    h += '<span class="badge badge-confusion">confusion</span> ';
    h += '<span class="badge badge-user" style="background:' + tagBg('ux', 0) + '">lost</span> ';
    if (proposed) {
        h += badgeProposed('information architecture', 'task', 0, 'Participant expected species categorised by habitat type \u2014 information architecture gap in taxonomy, not navigation placement');
    } else if (settled) {
        h += badgeConfirmed('information architecture', 'task', 0);
    }
    h += ' <span class="badge" style="background:transparent; border:1px dashed var(--bn-colour-border); color:var(--bn-colour-muted); cursor:pointer">+</span>';
    h += '</div></div></div>';
    h += '<div class="quote-actions"><button class="quote-action-btn">\u2606</button><button class="quote-action-btn">\u270E</button><button class="quote-action-btn" title="Hide">\u{1F441}</button></div>';
    h += '</blockquote>';

    // Quote 2 — with proposed tag
    h += '<blockquote>';
    h += '<div class="quote-row"><a class="timecode">0:07:22</a><div class="quote-body">';
    h += '<span class="quote-text">\u201cI can\u2019t find where to filter by tank size \u2014 I\u2019d expect that on the left sidebar somewhere.\u201d</span>';
    h += '&nbsp;<span class="speaker">\u2014&nbsp;<a class="speaker-link">[p1] Yuki Tanaka</a></span>';
    h += '<div class="badges">';
    h += '<span class="badge badge-frustration">frustration</span> ';
    if (proposed) {
        h += badgeProposed('component placement', 'trust', 3, 'Missing filter in expected sidebar location \u2014 layout/placement issue, not information architecture');
    } else if (settled) {
        h += badgeConfirmed('component placement', 'trust', 3);
    }
    h += ' <span class="badge" style="background:transparent; border:1px dashed var(--bn-colour-border); color:var(--bn-colour-muted); cursor:pointer">+</span>';
    h += '</div></div></div>';
    h += '<div class="quote-actions"><button class="quote-action-btn">\u2606</button><button class="quote-action-btn">\u270E</button><button class="quote-action-btn">\u{1F441}</button></div>';
    h += '</blockquote>';

    // Quote 3 — no framework tag
    h += '<blockquote>';
    h += '<div class="quote-row"><a class="timecode">0:08:55</a><div class="quote-body">';
    h += '<span class="quote-text">\u201cI always check three or four shops before buying \u2014 it\u2019s just habit, I don\u2019t trust anyone to have the best price.\u201d</span>';
    h += '&nbsp;<span class="speaker">\u2014&nbsp;<a class="speaker-link">[p2] Haruki Johansson</a></span>';
    h += '<div class="badges">';
    h += '<span class="badge badge-user" style="background:' + tagBg('trust', 0) + '">credibility concern</span> ';
    h += '<span class="badge" style="background:transparent; border:1px dashed var(--bn-colour-border); color:var(--bn-colour-muted); cursor:pointer">+</span>';
    h += '</div></div></div>';
    h += '<div class="quote-actions"><button class="quote-action-btn">\u2606</button><button class="quote-action-btn">\u270E</button><button class="quote-action-btn">\u{1F441}</button></div>';
    h += '</blockquote>';

    return h;
}

function renderPickerModal() {
    var h = '<div class="modal-overlay" id="picker-modal">';
    h += '<div class="modal modal-xl">';
    h += '<div class="modal-header">';
    h += '<div><div class="modal-title">Browse codebooks</div><div class="modal-subtitle">Import a framework codebook or create your own</div></div>';
    h += '<button class="modal-close" onclick="closePickerModal()">&times;</button>';
    h += '</div>';
    h += '<div class="modal-body">';

    // Frameworks row
    h += '<div class="picker-section-header"><span class="picker-section-title">Codebook frameworks</span></div>';
    h += '<div class="picker-row">';
    pickerCards.forEach(function(card) {
        var cls = 'picker-card';
        if (card.featured) cls += ' featured';
        if (!card.enabled) cls += ' disabled';
        if (card.imported) cls += ' imported';
        h += '<div class="' + cls + '" data-card="' + card.id + '" onclick="showPreview(\'' + card.id + '\')">';
        h += '<div class="picker-card-title">' + E(card.title) + '</div>';
        if (card.author) h += '<div class="picker-card-author">' + E(card.author) + '</div>';
        h += '<div class="picker-card-desc">' + E(card.desc) + '</div>';
        h += '<div class="picker-card-tags">';
        card.sampleTags.forEach(function(t) {
            h += badge(t.name, t.set, t.idx);
        });
        h += '</div>';
        if (!card.enabled) h += '<div class="picker-card-coming">Coming soon</div>';
        h += '</div>';
    });
    h += '</div>';

    // User codebooks row
    h += '<div class="picker-section-header"><span class="picker-section-title">Your codebooks</span></div>';
    h += '<div class="picker-row">';
    h += '<div class="picker-card picker-card-create"><span class="new-icon">+</span><span class="new-label">Create new codebook</span></div>';
    h += '<div class="picker-card"><div class="picker-card-title">Fishkeeping</div>';
    h += '<div class="picker-card-tags">' + badge('species knowledge', 'task', 0) + badge('equipment', 'opp', 0) + '</div></div>';
    h += '</div>';

    h += '</div></div></div>';
    return h;
}

function renderPreviewModal() {
    var h = '<div class="modal-overlay" id="preview-modal">';
    h += '<div class="modal modal-xl">';
    h += '<div class="modal-header">';
    h += '<div><div class="modal-title">The Elements of User Experience</div><div class="modal-subtitle">Jesse James Garrett</div></div>';
    h += '<div style="display:flex; align-items:center; gap:0.5rem; flex-shrink:0">';
    h += '<div style="text-align:right"><button class="bn-btn bn-btn-primary" onclick="importCodebook()">Import codebook</button>';
    h += '<div class="preview-cta-help">Adds to existing tags and tag-groups</div></div>';
    h += '<button class="modal-close" onclick="closePreviewModal()">&times;</button>';
    h += '</div></div>';
    h += '<div class="modal-body">';
    h += '<div class="preview-body">';
    h += '<div class="preview-body-main">';
    h += '<div class="preview-desc">Five mutually exclusive planes from abstract strategy to concrete surface design. A top-down framework for placing findings in the UX decision hierarchy. Each plane describes a different layer of product decisions \u2014 from why we build it (Strategy) to what it looks like (Surface).</div>';
    h += '<div class="preview-section-label">Tag groups</div>';
    h += '<div class="preview-groups">';
    garrettGroups.forEach(function(g) {
        h += '<div class="codebook-group" style="background:' + groupBg(g.colourSet) + '">';
        h += '<div class="group-header"><div class="group-title-area">';
        h += '<div class="group-title">' + E(g.name) + '</div>';
        h += '<div class="group-subtitle">' + E(g.subtitle) + '</div>';
        h += '</div></div><div class="tag-list">';
        g.tags.forEach(function(t, idx) {
            h += '<div class="tag-row"><div class="tag-name-area">' + badgeLg(t.name, g.colourSet, idx) + '</div></div>';
        });
        h += '</div></div>';
    });
    h += '</div></div>';
    h += '<div class="preview-body-sidebar"><div class="preview-author">';
    h += '<div class="preview-author-name">Jesse James Garrett</div>';
    h += '<div class="preview-author-bio">Co-founder of Adaptive Path. Coined the term \u201cAjax\u201d and created the five-plane model that became foundational to UX practice. Author of \u201cThe Elements of User Experience: User-Centered Design for the Web and Beyond\u201d (2002, 2nd edition 2010).</div>';
    h += '<div class="preview-author-links"><a href="#">jjg.net \u2197</a> <a href="#">Amazon US \u2197</a></div>';
    h += '</div></div>';
    h += '</div></div></div></div>';
    return h;
}

function renderReportModal() {
    var h = '<div class="modal-overlay" id="report-modal">';
    h += '<div class="modal modal-lg">';
    h += '<div class="modal-header">';
    h += '<div><div class="modal-title">\u2726 AutoCode Report \u2014 JJG Elements of UX</div>';
    h += '<div class="modal-subtitle" id="report-count">' + reportRows.length + ' tags proposed across 3 sessions</div></div>';
    h += '<button class="modal-close" onclick="closeReportModal()">&times;</button>';
    h += '</div>';
    h += '<div class="modal-body">';
    h += '<table class="report-table"><tbody>';

    // Session 1
    h += '<tr><td colspan="5" class="report-session-header">Session 1</td></tr>';
    reportRows.slice(0, 5).forEach(function(r, i) {
        h += renderReportRow(r, i);
    });

    // Session 3
    h += '<tr><td colspan="5" class="report-session-header">Session 3</td></tr>';
    reportRows.slice(5).forEach(function(r, i) {
        h += renderReportRow(r, i + 5);
    });

    h += '</tbody></table>';
    h += '</div>';
    h += '<div class="modal-footer">';
    h += '<button class="bn-btn" onclick="closeReportModal()">Cancel</button>';
    h += '<button class="bn-btn" onclick="closeReportModal()">Accept all</button>';
    h += '<button class="bn-btn bn-btn-primary" onclick="acceptAsProposed()">Tag tentatively</button>';
    h += '</div>';
    h += '</div></div>';
    return h;
}

function renderReportRow(r, i) {
    var h = '<tr class="report-row" id="report-row-' + i + '">';
    h += '<td class="report-timecode"><a href="#t-' + r.speakerCode + '-' + r.tc.replace(/:/g, '') + '" target="_blank">' + E(r.tc) + '</a></td>';
    h += '<td class="report-speaker"><span class="badge">' + E(r.speakerCode) + '</span></td>';
    h += '<td class="report-quote" title="' + E(r.quote) + '">' + E(r.quote) + '</td>';
    h += '<td class="report-tag"><span class="badge has-tooltip" style="background:' + tagBg(r.cs, r.idx) + '">';
    h += E(r.tag);
    h += '<span class="tooltip">' + E(r.rationale) + '</span></span></td>';
    h += '<td class="report-deny"><button class="report-deny-btn" onclick="denyRow(' + i + ')" title="Deny">\u2298</button></td>';
    h += '</tr>';
    return h;
}

// ================================================================
//  STEPS
// ================================================================

var steps = [
    { label: 'Codebook tab \u2014 before import', num: 1 },
    { label: 'Browse codebooks modal (picker)', num: 2 },
    { label: 'Codebook preview (Garrett)', num: 3 },
    { label: 'Codebook tab \u2014 after import, AutoCode available', num: 4 },
    { label: 'AutoCode running \u2014 progress toast', num: 5 },
    { label: 'AutoCode report modal \u2014 triage', num: 6 },
    { label: 'Proposed tags on quotes \u2014 pulsating', num: 7 },
    { label: 'Accept/Deny hover interaction', num: 8 },
    { label: 'Settled state \u2014 confirmed tags', num: 9 }
];

var currentStep = 0;

function renderStep(idx) {
    var content = document.getElementById('main-content');
    var chrome = document.querySelector('.bn-chrome');

    // Remove any existing modals/toasts
    document.querySelectorAll('.modal-overlay, .autocode-toast').forEach(function(el) { el.remove(); });

    var ann = '<div class="step-annotation"><span class="step-number">' + steps[idx].num + '</span><div>';

    switch (idx) {
        case 0: // Codebook tab before import
            ann += '<strong>Stage 0 \u2014 Before import.</strong> The researcher sees their existing codebook with a \u201cBrowse codebooks\u201d button top-right. No framework groups visible yet.</div></div>';
            content.innerHTML = ann + renderCodebookGrid(researcherGroups, [], null, false, null, 0);
            break;

        case 1: // Picker modal
            ann += '<strong>Stage 0 \u2014 Discover.</strong> Clicking \u201cBrowse codebooks\u201d opens a large modal with framework codebooks (horizontal scroll) and user codebooks. Norman/Morville are \u201cComing soon\u201d.</div></div>';
            content.innerHTML = ann + renderCodebookGrid(researcherGroups, [], null, false, null, 0);
            document.body.insertAdjacentHTML('beforeend', renderPickerModal());
            break;

        case 2: // Preview
            ann += '<strong>Stage 0 \u2014 Preview.</strong> Clicking the Garrett card opens the preview with author bio, all 5 tag groups, and an \u201cImport codebook\u201d CTA. The researcher can read and understand the framework before committing.</div></div>';
            content.innerHTML = ann + renderCodebookGrid(researcherGroups, [], null, false, null, 0);
            document.body.insertAdjacentHTML('beforeend', renderPreviewModal());
            break;

        case 3: // After import
            ann += '<strong>Stage 1 \u2014 Invoke ready.</strong> After import, Garrett\u2019s 5 groups appear below the framework separator with the <span style="color:var(--bn-colour-accent)">\u2726 AutoCode quotes</span> button. All counts are 0.</div></div>';
            content.innerHTML = ann + renderCodebookGrid(researcherGroups, garrettGroups, 'Jesse James Garrett \u2014 Elements of UX', true, 'ready', 0);
            break;

        case 4: // AutoCode running
            ann += '<strong>Stage 1 \u2014 Running.</strong> After clicking AutoCode, a floating toast shows progress. The AutoCode button is disabled. The researcher can continue working \u2014 the toast persists even if they switch tabs.</div></div>';
            content.innerHTML = ann + renderCodebookGrid(researcherGroups, garrettGroups, 'Jesse James Garrett \u2014 Elements of UX', true, 'done', 0);
            // Show toast
            document.body.insertAdjacentHTML('beforeend',
                '<div class="autocode-toast" id="running-toast">' +
                '<div class="toast-spinner"></div>' +
                '<span>\u2726 AutoCoding 3/7 transcripts\u2026</span>' +
                '<button class="toast-close">&times;</button>' +
                '</div>'
            );
            // Simulate completion after 3s
            setTimeout(function() {
                var t = document.getElementById('running-toast');
                if (t) {
                    t.innerHTML = '<span class="toast-check">\u2713</span>' +
                        '<span>\u2726 AutoCoded 7 transcripts in 2:34.</span>' +
                        '<a class="toast-link" onclick="changeStep(1)">Report</a>' +
                        '<button class="toast-close">&times;</button>';
                }
            }, 3000);
            break;

        case 5: // Report modal
            ann += '<strong>Stage 2 \u2014 Review.</strong> The report modal shows all proposed tags grouped by session. Each row has a timecode, speaker badge, truncated quote, coloured tag badge, and a deny button (\u2298). Hover a tag badge to see the LLM\u2019s rationale.</div></div>';
            content.innerHTML = ann + renderCodebookGrid(researcherGroups, garrettGroups, 'Jesse James Garrett \u2014 Elements of UX', true, 'done', 0);
            document.body.insertAdjacentHTML('beforeend', renderReportModal());
            break;

        case 6: // Proposed badges on quotes
            ann += '<strong>Stage 3 \u2014 Land.</strong> After \u201cTag tentatively\u201d, tags appear on quotes with a pulsating dashed border at reduced opacity. The codebook panel shows updated counts and a \u201c33 proposed\u201d indicator.</div></div>';
            content.innerHTML = ann + renderQuotes(true, false) +
                '<div style="margin-top:2rem; border-top:1px solid var(--bn-colour-border); padding-top:1.5rem">' +
                renderCodebookGrid(researcherGroups, garrettGroupsWithCounts, 'Jesse James Garrett \u2014 Elements of UX', true, 'done', 33) +
                '</div>';
            break;

        case 7: // Accept/Deny hover
            ann += '<strong>Stage 4 \u2014 Resolve.</strong> Hover a proposed badge to stop the pulse and reveal \u2713 Accept and \u2717 Deny buttons. The tooltip shows the LLM rationale. Try hovering the pulsating badges below.</div></div>';
            content.innerHTML = ann + renderQuotes(true, false);
            break;

        case 8: // Settled
            ann += '<strong>Stage 5 \u2014 Settled.</strong> After accepting, tags become solid badges \u2014 indistinguishable from manually applied tags. They appear in the codebook panel with updated counts.</div></div>';
            content.innerHTML = ann + renderQuotes(false, true);
            break;
    }

    // Update nav
    document.getElementById('step-counter').textContent = (idx + 1) + ' / ' + steps.length;
    document.getElementById('step-label').textContent = steps[idx].label;
    document.getElementById('step-prev').disabled = idx === 0;
    document.getElementById('step-next').disabled = idx === steps.length - 1;
}

function changeStep(delta) {
    var next = currentStep + delta;
    if (next >= 0 && next < steps.length) {
        currentStep = next;
        renderStep(currentStep);
    }
}

// Modal helpers
function openPickerModal() { changeStep(1 - currentStep); /* go to step 1 */ }
function closePickerModal() {
    var m = document.getElementById('picker-modal');
    if (m) m.remove();
}
function showPreview(id) {
    closePickerModal();
    document.body.insertAdjacentHTML('beforeend', renderPreviewModal());
}
function closePreviewModal() {
    var m = document.getElementById('preview-modal');
    if (m) m.remove();
}
function importCodebook() {
    closePreviewModal();
    currentStep = 3;
    renderStep(3);
}
function closeReportModal() {
    var m = document.getElementById('report-modal');
    if (m) m.remove();
}
function acceptAsProposed() {
    closeReportModal();
    currentStep = 6;
    renderStep(6);
}

function denyRow(i) {
    var row = document.getElementById('report-row-' + i);
    if (row) {
        row.classList.add('removing');
        setTimeout(function() { row.remove(); updateReportCount(); }, 200);
    }
}
function updateReportCount() {
    var rows = document.querySelectorAll('.report-row:not(.removing)');
    var el = document.getElementById('report-count');
    if (el) el.textContent = rows.length + ' tags proposed across 3 sessions';
}

function toggleTheme() {
    var h = document.documentElement;
    h.setAttribute('data-theme', h.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
}

// Keyboard nav
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); changeStep(1); }
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); changeStep(-1); }
});

// Boot
renderStep(0);
</script>
</body>
</html>
